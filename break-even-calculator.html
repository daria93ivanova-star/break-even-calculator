<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Калькулятор точки безубыточности</title>
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen w-full bg-gradient-to-b from-white to-slate-50 text-slate-800">
    <div id="root"></div>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts UMD -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <script type="text/babel">
      const { useMemo, useState } = React;
      const {
        LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ReferenceLine, ResponsiveContainer, Label
      } = Recharts;

      const parseNumber = (value) => {
        if (value === null || value === undefined) return 0;
        const cleaned = String(value)
          .replace(/[^0-9.,\-]/g, "")
          .replace(/,(?=\d{3}(\D|$))/g, "")
          .replace(/\s+/g, "")
          .replace(",", ".");
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : 0;
      };

      const fmtCurrency = (n, currency) => {
        try {
          return new Intl.NumberFormat(undefined, {
            style: "currency",
            currency,
            maximumFractionDigits: 0,
          }).format(n);
        } catch (e) {
          return `${currency} ${n.toLocaleString()}`;
        }
      };

      const fmtNumber = (n) => new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 }).format(n);

      function KPI({ title, value, hint, tone = "neutral" }) {
        const toneClasses =
          tone === "good"
            ? "bg-emerald-50 border-emerald-200"
            : tone === "bad"
            ? "bg-rose-50 border-rose-200"
            : "bg-white border-slate-200";
        return (
          <div className={`rounded-3xl border ${toneClasses} p-4 shadow-sm`}>
            <div className="text-sm text-slate-500">{title}</div>
            <div className="mt-1 text-2xl font-semibold">{value}</div>
            {hint && <div className="mt-1 text-xs text-slate-500">{hint}</div>}
          </div>
        );
      }

      function Tip({ title, children }) {
        return (
          <div className="rounded-3xl border border-slate-200 bg-white p-4 shadow-sm">
            <div className="mb-1 text-sm font-semibold">{title}</div>
            <div className="text-sm text-slate-600">{children}</div>
          </div>
        );
      }

      function BreakEvenCalculator() {
        const [currency, setCurrency] = useState("CAD");
        const [fixedCosts, setFixedCosts] = useState("15000");
        const [price, setPrice] = useState("25");
        const [variableCost, setVariableCost] = useState("12");
        const [expectedUnits, setExpectedUnits] = useState("1200");

        const fc = useMemo(() => parseNumber(fixedCosts), [fixedCosts]);
        const p = useMemo(() => parseNumber(price), [price]);
        const vc = useMemo(() => parseNumber(variableCost), [variableCost]);
        const qExp = useMemo(() => Math.max(0, parseNumber(expectedUnits)), [expectedUnits]);

        const contr = Math.max(0, p - vc);
        const breakEvenUnits = contr > 0 ? Math.ceil(fc / contr) : Infinity;
        const breakEvenRevenue = contr > 0 ? breakEvenUnits * p : Infinity;

        const revenueExp = qExp * p;
        const profitExp = qExp * (p - vc) - fc;
        const marginPct = p > 0 ? ((p - vc) / p) * 100 : 0;
        const marginOfSafetyUnits = qExp > 0 && contr > 0 ? Math.max(0, qExp - breakEvenUnits) : 0;
        const marginOfSafetyPct = qExp > 0 && contr > 0 ? (marginOfSafetyUnits / qExp) * 100 : 0;

        const qMax = useMemo(() => {
          if (!Number.isFinite(breakEvenUnits)) return Math.max(qExp, 1000);
          const base = Math.max(breakEvenUnits, qExp, 20);
          return Math.ceil(base * 1.6);
        }, [breakEvenUnits, qExp]);

        const chartData = useMemo(() => {
          const step = Math.max(1, Math.floor(qMax / 50));
          const data = [];
          for (let q = 0; q <= qMax; q += step) {
            const profit = q * (p - vc) - fc;
            data.push({ q, profit });
          }
          return data;
        }, [qMax, p, vc, fc]);

        const invalid = p <= 0 || vc < 0 || fc < 0 || (p - vc) <= 0;

        return (
          <div className="mx-auto max-w-6xl px-4 py-8">
            <header className="mb-6">
              <h1 className="text-3xl md:text-4xl font-bold tracking-tight">Калькулятор точки безубыточности</h1>
              <p className="mt-2 text-slate-600 max-w-3xl">
                Узнайте, сколько нужно продать, чтобы покрыть постоянные расходы. Введите цену, переменные издержки и постоянные расходы — всё посчитается автоматически.
              </p>
            </header>

            <section className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
              <div className="md:col-span-2">
                <label className="block text-sm font-medium mb-1">Валюта</label>
                <select
                  value={currency}
                  onChange={(e) => setCurrency(e.target.value)}
                  className="w-full rounded-2xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                >
                  <option value="CAD">CAD</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="RUB">RUB</option>
                </select>
              </div>

              <div className="md:col-span-3">
                <label className="block text-sm font-medium mb-1">Постоянные расходы (в месяц)</label>
                <input
                  inputMode="decimal"
                  value={fixedCosts}
                  onChange={(e) => setFixedCosts(e.target.value)}
                  className="w-full rounded-2xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                  placeholder="Напр.: 15000"
                />
              </div>

              <div className="md:col-span-3">
                <label className="block text-sm font-medium mb-1">Цена за единицу</label>
                <input
                  inputMode="decimal"
                  value={price}
                  onChange={(e) => setPrice(e.target.value)}
                  className="w-full rounded-2xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                  placeholder="Напр.: 25"
                />
              </div>

              <div className="md:col-span-3">
                <label className="block text-sm font-medium mb-1">Переменные издержки на единицу</label>
                <input
                  inputMode="decimal"
                  value={variableCost}
                  onChange={(e) => setVariableCost(e.target.value)}
                  className="w-full rounded-2xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                  placeholder="Напр.: 12"
                />
              </div>

              <div className="md:col-span-12">
                <label className="block text-sm font-medium mb-1">Ожидаемый объём продаж (необязательно)</label>
                <input
                  inputMode="numeric"
                  value={expectedUnits}
                  onChange={(e) => setExpectedUnits(e.target.value.replace(/[^0-9]/g, ""))}
                  className="w-full rounded-2xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400"
                  placeholder="Напр.: 1200"
                />
              </div>
            </section>

            {invalid && (
              <div className="mt-4 rounded-2xl border border-amber-300 bg-amber-50 p-3 text-amber-800">
                Введите корректные значения: цена должна быть больше переменных издержек, все расходы — неотрицательные.
              </div>
            )}

            <section className="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
              <KPI title="Вклад на единицу" value={fmtCurrency(Math.max(0, p - vc), currency)} hint="Цена − переменные издержки" />
              <KPI title="Точка безубыточности, шт" value={Number.isFinite(breakEvenUnits) ? fmtNumber(breakEvenUnits) : "—"} hint="Постоянные / вклад" />
              <KPI title="Точка безубыточности, выручка" value={Number.isFinite(breakEvenRevenue) ? fmtCurrency(breakEvenRevenue, currency) : "—"} hint="ТБ × цена" />
              <KPI title="Маржинальность, %" value={`${marginPct.toFixed(1)}%`} hint="(Цена − издержки) / цена" />
            </section>

            {qExp > 0 && (
              <section className="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <KPI title="Плановая прибыль" value={fmtCurrency(profitExp, currency)} hint="(Вклад × объём) − постоянные" tone={profitExp >= 0 ? "good" : "bad"} />
                <KPI title="Запас прочности, шт" value={fmtNumber(marginOfSafetyUnits)} hint="Ожидаемый объём − ТБ" />
                <KPI title="Запас прочности, %" value={`${marginOfSafetyPct.toFixed(1)}%`} />
                <div className="rounded-3xl border border-slate-200 bg-white p-4 shadow-sm text-sm text-slate-600">
                  <div className="text-sm font-semibold mb-1">Подсказка</div>
                  Если у вас несколько товаров, используйте средневзвешенный вклад на единицу.
                </div>
              </section>
            )}

            <section className="mt-8 rounded-3xl border border-slate-200 bg-white p-4 shadow-sm">
              <div className="flex items-baseline justify-between">
                <h2 className="text-lg font-semibold">Профит по объёму продаж</h2>
                <p className="text-sm text-slate-500">Линия = прибыль, пунктир = точка безубыточности</p>
              </div>
              <div className="h-80 w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={chartData} margin={{ top: 10, right: 20, left: 0, bottom: 10 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="q">
                      <Label value="Единиц продано" offset={-5} position="insideBottom" />
                    </XAxis>
                    <YAxis tickFormatter={(v) => fmtCurrency(v, currency)}>
                      <Label value="Прибыль" angle={-90} position="insideLeft" />
                    </YAxis>
                    <Tooltip
                      formatter={(value, name) => [fmtCurrency(Number(value), currency), name]}
                      labelFormatter={(label) => `Объём: ${fmtNumber(label)} шт`}
                    />
                    <Line type="monotone" dataKey="profit" stroke="#2563eb" strokeWidth={2} dot={false} />
                    {Number.isFinite(breakEvenUnits) && (
                      <ReferenceLine x={breakEvenUnits} stroke="#ef4444" strokeDasharray="4 4" />
                    )}
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </section>

            <footer className="mt-10 text-center text-xs text-slate-500">
              Формулы: вклад = цена − переменные издержки; ТБ (шт) = постоянные / вклад; прибыль = вклад × объём − постоянные.
            </footer>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<BreakEvenCalculator />);
    </script>
  </body>
</html>
